# 環境構築手順
## 必要環境
このプログラムを動作させるには、以下のアプリケーションが稼働する環境が必要です。

* Java SDK 11 以降
* Maven 3.5 以降

## コンパイル
以下のコマンドでコンパイルを行います。

```
$ mvn clean package
```

コンパイルが完了すると、`target`フォルダに`webauthn-demo-0.0.1-SNAPSHOT.jar`ファイルが作成されます。

# 動作手順
## 1.プログラムの起動
以下のコマンドでプログラムを実行します。

```
$ java -jar target/webauthn-demo-0.0.1-SNAPSHOT.jar
```

SpringBootが起動したら、ブラウザで以下のサイトにアクセスします。
> https://localhost:8443

[オレオレ証明書](https://ja.wikipedia.org/wiki/%E8%87%AA%E5%B7%B1%E7%BD%B2%E5%90%8D%E8%A8%BC%E6%98%8E%E6%9B%B8)を使用しているので、アクセス直後はプライバシーエラーが表示されますが、無視してアクセスします。

## 2.アカウント作成
「アカウント作成」画面が表示されるので、「名前」と「e-mail」に適当な値を設定して「アカウント作成」ボタンを押します。

CTAPによる認証画面が表示されるので、適切な認証を選択して、アカウントを作成します。

アカウントが正常に作成できると「登録しました」のメッセージが表示され、ログイン画面に遷移します。

## 3.ログイン
「ログイン」画面では「アカウント作成」画面で入力した「e-mail」を入力して「ログイン」ボタンを押します。

CTAPによる認証画面が表示されるので、「アカウント作成」画面で使用した認証を選択して、ログインを行います。

ログインに成功すると「ログインしました」のメッセージが表示されます。

# 作成されたアカウントの確認
作成されたアカウント情報を確認するには、ブラウザで以下のサイトにアクセスします。
> https://localhost:8443/h2-console

ログイン画面が表示されるので、そのまま「Connect」ボタンを押します。

[H2 Database Engine](https://www.h2database.com/html/main.html)のコンソール画面が表示されます。

各テーブルは、以下の内容を管理しています。
* USER
  * 作成したログインユーザ情報を管理します。
* CREDENTIAL
  * ユーザに紐付いた証明書情報を管理します。
  * 同一のユーザに複数の証明書を関連付けることも可能です。

# コード上の注意点
このコードは`challenge`の管理に`HTTP Session`を使用しているため、冗長化を想定していません。  
冗長化を行う場合は`challenge`の管理方法を検討する必要があります。

# Thank you
このコードは[WEB+DB PRESS Vol.114](https://gihyo.jp/magazine/wdpress/archive/2020/vol114)の記事を参考に、独自の解釈を加えたコードになっています。
